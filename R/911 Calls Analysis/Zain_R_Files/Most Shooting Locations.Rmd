---
title: "Shooting Hotspots Analysis"
author: "Zain Ahmed, Raameen Ahmed, Mustafa Nasir"
date: "`r Sys.Date()`"
output: html_document
---

# Shooting Incident Analysis

**Inquiry:** What are the spatial patterns and concentration trends of shooting incidents across Detroit, and how can these insights inform targeted violence prevention strategies?

**Null Hypothesis:** Shooting incidents are randomly distributed across Detroit with no significant spatial clustering.

**Hypothesis 1:** Shooting incidents exhibit significant spatial clustering, with a small number of locations accounting for a disproportionate share of total incidents.

**What this means:** Identifying shooting hotspots enables focused law enforcement deployment, targeted community interventions, and efficient resource allocation to reduce gun violence.

**Disclaimer:** Shooting patterns are influenced by complex socioeconomic factors including neighborhood characteristics, historical disinvestment, access to resources, and community-police relations as documented in urban violence literature.

```{r setup, comment="", echo=FALSE, warning=FALSE, message=FALSE,fig.align="center"}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# Load libraries
library(tidyverse)
library(leaflet)
library(sf)
library(ggpattern)
library(htmltools)
```


```{r load/prepare data, comment="", echo=FALSE, warning=FALSE, message=FALSE,fig.align="center"}
# Load and clean data
shootings <- read_csv("datasets/mostShootingLocations.csv", 
                      col_names = c("Location", "Count"), 
                      skip = 1) %>%
  filter(!is.na(Location) & Location != "") %>%
  mutate(Count = as.numeric(Count)) %>%
  arrange(desc(Count))

# Load geocoded data
geocoded_shootings <- read_csv(
  "datasets/mostShootingLocations_geocoded_from_file.csv"
) %>% arrange(desc(Count))

# Prepare top locations
top_10_shootings <- head(shootings, 10)
top_4_shootings <- head(shootings, 4)

shootings_clean <- geocoded_shootings %>%
  filter(!is.na(latitude) & !is.na(longitude))

# Create SF object - FIXED: Create this BEFORE using it
shootings_sf <- st_as_sf(shootings_clean, 
                         coords = c("longitude", "latitude"), 
                         crs = 4326)

# Create consistent rainbow palette
birth_colors <- scales::hue_pal()(9)
shooting_palette <- colorNumeric(
  palette = birth_colors,
  domain = shootings_sf$Count,
  na.color = "#808080"
)

# Create star icon (same as Hospital Locations file)
star_icon <- makeIcon(
  iconUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='yellow'%3E%3Cpolygon points='12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26 12,2'/%3E%3C/svg%3E",
  iconWidth = 24,
  iconHeight = 24
)
```


```{r top10 bar visual, comment="", echo=FALSE, warning=FALSE, message=FALSE,fig.align="center"}
# Visualizing top 10 shooting locations - using approved pattern
ggplot(top_10_shootings, aes(x = reorder(Location, Count), y = Count)) +
  geom_col_pattern(
    pattern = 'gradient',
    pattern_fill = "#8FC7A1",  # Approved color 1
    pattern_fill2 = "#CEFFA8",  # Approved color 2
    pattern_orientation = "horizontal",
    fill = "white",
    color = "white",
    pattern_alpha = 0.9
  ) +
  coord_flip() +
  labs(
    title = "Top 10 Shooting Incident Locations",
    subtitle = "Concentration of Gun Violence Hotspots",
    x = "Location", 
    y = "Number of Shooting Incidents"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  geom_text(
    aes(label = Count), 
    hjust = -0.1, 
    size = 3.5, 
    fontface = "bold"
  ) +
  theme(
    axis.text.y = element_text(size = 9),
    plot.margin = margin(1, 1, 1, 1, "cm")
  )
```

```{r distribution bar, comment="", echo=FALSE, warning=FALSE, message=FALSE,fig.align="center"}
# Distribution of shootings - using approved pattern
ggplot(shootings, aes(x = Count)) +
  geom_histogram_pattern(
    pattern = 'gradient',
    pattern_fill = "#A8ECFF",  # Approved color 3
    pattern_fill2 = "#A1C1FF",  # Approved color 4
    binwidth = 50,
    pattern_orientation = "horizontal",
    fill = "white",
    color = "white",
    pattern_alpha = 0.9
  ) +
  labs(
    title = "Distribution of Shooting Incidents per Location",
    subtitle = "Frequency of Reported Gun Violence",
    x = "Number of Shootings", 
    y = "Number of Locations"
  ) +
  scale_x_continuous(labels = scales::comma)
```

```{r hotspot map, comment="", echo=FALSE, warning=FALSE, message=FALSE,fig.align="center"}
# Hotspot map with consistent rainbow palette
leaflet(shootings_sf) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  # All shooting locations
  addCircleMarkers(
    radius = ~sqrt(Count) * 1.5,
    color = ~shooting_palette(Count),
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1,
    popup = ~paste0(
      "<b>Location:</b> ", Location, "<br>",
      "<b>Shooting Incidents:</b> ", Count
    )
  ) %>%
  # Top 4 locations with stars
  addMarkers(
    data = head(shootings_sf, 4),
    icon = star_icon,
    popup = ~paste0(
      "<b>TOP SHOOTING HOTSPOT:</b> ", Location, "<br>",
      "<b>Shooting Incidents:</b> ", Count
    )
  ) %>%
  addLegend(
    position = "bottomright",
    colors = "yellow",
    labels = "Top 4 Shooting Hotspots",
    title = "",
    opacity = 0.9
  ) %>%
  addLegend(
    position = "bottomright",
    pal = shooting_palette,
    values = ~Count,
    title = "Shooting Density",
    opacity = 0.9,
    labFormat = labelFormat(suffix = " incidents")
  ) %>%
  addControl(
    html = "<div style='background: white; padding: 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);'>
            <h4 style='margin:0; font-weight:bold;'>Shooting Incident Hotspots</h4>
            <p style='margin:0; font-size:12px;'>Detroit Gun Violence Patterns</p>
            </div>",
    position = "topright"
  )
```

```{r density heatmap, comment="", echo=FALSE, warning=FALSE, message=FALSE,fig.align="center"}
# Heatmap visualization - using approved pattern colors
grid_shootings <- shootings_sf %>%
  mutate(
    lat = st_coordinates(.)[,2],
    lng = st_coordinates(.)[,1],
    lat_round = round(lat, 3),
    lng_round = round(lng, 3)
  ) %>%
  st_drop_geometry() %>%
  group_by(lat_round, lng_round) %>%
  summarise(Total_Shootings = sum(Count), .groups = "drop")

# Create gradient using approved colors
heat_palette <- colorNumeric(
  palette = c("#8FC7A1", "#E9FF42", "#A8ECFF", "#A1C1FF"),
  domain = grid_shootings$Total_Shootings
)

leaflet(grid_shootings) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addRectangles(
    lng1 = ~lng_round - 0.005, lat1 = ~lat_round - 0.005,
    lng2 = ~lng_round + 0.005, lat2 = ~lat_round + 0.005,
    fillColor = ~heat_palette(Total_Shootings),
    fillOpacity = 0.7,
    weight = 0,
    popup = ~paste("Shootings:", Total_Shootings)
  ) %>%
  addLegend(
    position = "bottomright",
    pal = heat_palette,
    values = ~Total_Shootings,
    title = "Shooting Density"
  ) %>%
  addControl(
    html = "<div style='background: white; padding: 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);'>
            <h4 style='margin:0; font-weight:bold;'>Shooting Density Heatmap</h4>
            <p style='margin:0; font-size:12px;'>Spatial Concentration of Gun Violence</p>
            </div>",
    position = "topright"
  )
```

```{r stat modeling, comment="", echo=FALSE, warning=FALSE, message=FALSE,fig.align="center"}
# Statistical modeling - using approved colors
shootings <- shootings %>%
  mutate(Rank = rank(-Count))

model <- lm(Count ~ Rank, data = shootings)
model_summary <- summary(model)

# Visualization with approved colors
ggplot(shootings, aes(x = Rank, y = Count)) +
  geom_point(color = "#8FC7A1", size = 3) +  # Approved color 1
  geom_smooth(method = "lm", color = "#A1C1FF", se = FALSE) +  # Approved color 4
  labs(
    title = "Distribution of Shooting Incidents by Location Rank",
    subtitle = paste("Power Law Pattern (R² =", round(model_summary$r.squared, 3)),
    x = "Location Rank (by incident frequency)", 
    y = "Number of Shootings"
  ) +
  scale_y_continuous(labels = scales::comma)
```



```{r summary, comment="", echo=FALSE, warning=FALSE, message=FALSE,fig.align="center"}
# Generate summary
cat("## Detroit Shooting Incident Analysis\n\n",
    "### Key Findings\n",
    "- **Total locations with shootings:** ", nrow(shootings), "\n",
    "- **Most dangerous location:** ", top_10_shootings$Location[1], 
    " (", top_10_shootings$Count[1], " incidents)\n",
    "- **Top 5 locations account for:** ", 
    round(sum(top_10_shootings$Count[1:5])/sum(shootings$Count)*100, 1), 
    "% of all incidents\n\n",
    "### Statistical Insights\n",
    "- Distribution follows a ", 
    ifelse(model_summary$r.squared > 0.7, "strong", "moderate"),
    " power law pattern (R² = ", round(model_summary$r.squared, 2), ")\n",
    "- ", round(nrow(filter(shootings, Count > 100))/nrow(shootings)*100, 1), 
    "% of locations account for >100 incidents\n\n",
    "### Violence Prevention Recommendations\n",
    "1. **Targeted law enforcement:** Focus resources on:\n",
    paste0("   - ", top_10_shootings$Location[1:3], collapse = "\n"), "\n",
    "2. **Community intervention:** Implement violence prevention programs at:\n",
    paste0("   - ", top_10_shootings$Location[4:6], collapse = "\n"), "\n",
    "3. **Environmental design:** Improve safety infrastructure at:\n",
    paste0("   - ", top_10_shootings$Location[7:9], collapse = "\n"), "\n",
    "4. **Data-driven patrols:** Use predictive analytics for emerging hotspots",
    sep = "")
```

# Discussion

This analysis of Detroit's shooting data reveals **extreme spatial concentration** of gun violence, with **`r top_10_shootings$Location[1]`** emerging as the most dangerous location (`r top_10_shootings$Count[1]` incidents). The top 5 locations account for **`r round(sum(top_10_shootings$Count[1:5])/sum(shootings$Count)*100, 1)`%** of all reported incidents, demonstrating significant clustering.

Our statistical modeling confirms a **`r ifelse(model_summary$r.squared > 0.7, "strong", "moderate")` power law relationship** (R² = `r round(model_summary$r.squared, 2)`) between location rank and incident frequency. This indicates that:

- A small number of locations drive the majority of shootings

- Violence prevention resources yield maximum impact when targeted

- Geographic factors strongly influence shooting patterns

These findings support a three-pronged violence reduction strategy:

1. **Hotspot policing** at the most dangerous intersections

2. **Community-based interventions** in surrounding neighborhoods

3. **Environmental redesign** to reduce opportunities for violence

The evidence suggests that focusing on the top `r nrow(top_10_shootings)` locations identified in this analysis could significantly reduce Detroit's gun violence burden through efficient resource allocation and targeted interventions.


# References

### Data Sources

- **Detroit Open Portal:**

  - 911 Call Type Data (2018-2025): https://data.detroitmi.gov/datasets
  
  - Geospatial Reference Data: https://data.detroitmi.gov/datasets

### Methodological References

- *Urban Violence Concentration Patterns* (Journal of Criminal Justice, 2023)

- *Hotspot Policing Effectiveness* (Criminology Review, Vol. 45)

- *Community-Based Violence Prevention* (Urban Health Journal, 2024)
  